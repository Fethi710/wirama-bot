import express from "express";
import bodyParser from "body-parser";
import fetch from "node-fetch";
import OpenAI from "openai";

const app = express();
app.use(bodyParser.json());

const PAGE_ACCESS_TOKEN = process.env.PAGE_ACCESS_TOKEN;
const VERIFY_TOKEN = process.env.VERIFY_TOKEN;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const WOOCOMMERCE_URL = process.env.WOOCOMMERCE_URL;
const WOOCOMMERCE_CONSUMER_KEY = process.env.WOOCOMMERCE_CONSUMER_KEY;
const WOOCOMMERCE_CONSUMER_SECRET = process.env.WOOCOMMERCE_CONSUMER_SECRET;

const openai = new OpenAI({ apiKey: OPENAI_API_KEY });

// ðŸ“¦ ÙˆØ¸ÙŠÙØ© ØªØ¬ÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† WooCommerce
async function getProductPrice(productName) {
  try {
    const response = await fetch(
      `${WOOCOMMERCE_URL}/wp-json/wc/v3/products?search=${encodeURIComponent(
        productName
      )}&consumer_key=${WOOCOMMERCE_CONSUMER_KEY}&consumer_secret=${WOOCOMMERCE_CONSUMER_SECRET}`
    );

    const products = await response.json();
    if (products.length === 0) return null;

    const p = products[0];
    return {
      name: p.name,
      price: p.price,
      link: p.permalink,
      image: p.images?.[0]?.src || null,
    };
  } catch (err) {
    console.error("Erreur WooCommerce:", err);
    return null;
  }
}

// ðŸ¤– ÙˆØ¸ÙŠÙØ© ØªØªØ¹Ø±Ù‘Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©
async function getProductFromImage(imageUrl) {
  try {
    const response = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content:
            "Ø¥Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© Ø§Ù„ØªÙˆÙ†Ø³ÙŠØ©. Ø´ÙˆÙ Ø§Ù„ØµÙˆØ±Ø© ÙˆÙ‚ÙˆÙ„ÙŠ Ø´Ù†ÙˆÙ‘Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø¶Ø¨Ø· Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù‚ØµÙŠØ±Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø·Ù†Ø¬Ø±Ø©ØŒ Ø³Ø±Ø¨ÙŠØ³ Ù‚Ù‡ÙˆØ©ØŒ ÙƒØ§Ø³Ø§Øª...).",
        },
        {
          role: "user",
          content: [
            { type: "text", text: "Ø´Ù†ÙˆÙ‘Ø© Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©ØŸ" },
            { type: "image_url", image_url: imageUrl },
          ],
        },
      ],
    });

    const description = response.choices[0].message.content;
    return description;
  } catch (err) {
    console.error("Erreur Vision:", err);
    return null;
  }
}

// âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Messenger
async function sendMessage(senderId, message) {
  await fetch(`https://graph.facebook.com/v17.0/me/messages?access_token=${PAGE_ACCESS_TOKEN}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      recipient: { id: senderId },
      message: { text: message },
    }),
  });
}

// ðŸ–¼ï¸ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© + Ù†Øµ
async function sendImageMessage(senderId, imageUrl, text) {
  await fetch(`https://graph.facebook.com/v17.0/me/messages?access_token=${PAGE_ACCESS_TOKEN}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      recipient: { id: senderId },
      message: {
        attachment: {
          type: "image",
          payload: { url: imageUrl, is_reusable: true },
        },
      },
    }),
  });

  await sendMessage(senderId, text);
}

// ðŸ“¬ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
app.post("/webhook", async (req, res) => {
  const body = req.body;

  if (body.object === "page") {
    for (const entry of body.entry) {
      const webhookEvent = entry.messaging[0];
      const senderId = webhookEvent.sender.id;

      if (webhookEvent.message) {
        const msg = webhookEvent.message.text?.toLowerCase() || "";

        // ðŸ”¹ Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªØ±Ø­ÙŠØ¨
        if (["Ø³Ù„Ø§Ù…", "Ù…Ø±Ø­Ø¨Ø§", "Ø£Ù‡Ù„Ø§", "bonjour", "hi"].some((w) => msg.includes(w))) {
          await sendMessage(
            senderId,
            "Ø£Ù‡Ù„Ø§ ÙˆØ³Ù‡Ù„Ø§ Ø¨ÙŠÙƒ ÙÙŠ ÙˆÙŠØ±Ø§Ù…Ø§ Ø³ØªÙˆØ± ðŸŒ¸ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…ØªØ®ØµÙ‘Øµ ÙÙŠ Ø§Ù„Ø£ÙˆØ§Ù†ÙŠ Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù…ØªØ§Ø²Ø© âœ¨\nØ§Ù„ØªÙˆØµÙŠÙ„ Ù…ØªÙˆÙÙ‘Ø± Ù„ÙƒØ§Ù…Ù„ ØªØ±Ø§Ø¨ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø¨Ù€Ù€ 8 Ø¯Øª ðŸ‡¹ðŸ‡³ðŸšš\nØ´Ù†ÙˆÙ‘Ø© ØªØ­Ø¨ Ù†Ø³Ø§Ø¹ÙØ¯Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ Ø§Ø¨Ø¹Ø«Ù„ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªÙˆØ¬ ÙˆÙ„Ø§ ØªØµÙˆÙŠØ±Ø© Ù…ØªØ§Ø¹Ùˆ â¤ï¸"
          );
          continue;
        }

        // ðŸ”¹ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±
        if (webhookEvent.message.attachments && webhookEvent.message.attachments[0].type === "image") {
          const imageUrl = webhookEvent.message.attachments[0].payload.url;
          const guess = await getProductFromImage(imageUrl);
          const product = await getProductPrice(guess);

          if (product) {
            let reply = `ðŸŒŸ ${product.name}\nØ§Ù„Ø³Ø¹Ø± Ù…ØªØ§Ø¹Ù‡Ø§: ${product.price} Ø¯Øª ðŸ’¸\n`;
            reply += `Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…ØªÙˆÙÙ‘Ø± Ù„ÙƒØ§Ù…Ù„ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø¨Ù€Ù€ 8 Ø¯Øª ðŸ‡¹ðŸ‡³ðŸšš\n`;
            reply += `ØªÙ†Ø¬Ù… ØªØ´ÙˆÙÙ‡Ø§ ÙˆØªØ·Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ø°Ø§ ðŸ‘‡\n${product.link}\n\n`;
            reply += `Ù…Ù†ØªÙˆØ¬ Ù…Ø¶Ù…ÙˆÙ† Ø¨Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ© Ù…Ù† ÙˆÙŠØ±Ø§Ù…Ø§ Ø³ØªÙˆØ± ðŸ˜‰`;
            await sendImageMessage(senderId, product.image, reply);
          } else {
            await sendMessage(senderId, `Ù…Ø§ Ù„Ù‚ÙŠØªØ´ Ù†ÙØ³ Ø§Ù„Ù…Ù†ØªÙˆØ¬ ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø± ðŸ˜”ØŒ ØªÙ†Ø¬Ù… ØªÙƒØªØ¨Ù„ÙŠ Ø§Ø³Ù…Ùˆ Ø¨Ø§Ø´ Ù†Ø¹Ø§ÙˆÙ†Ùƒ Ø®ÙŠØ± â¤ï¸`);
          }
        }

        // ðŸ”¹ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù†Øµ
        else if (webhookEvent.message.text) {
          const text = webhookEvent.message.text;
          const product = await getProductPrice(text);

          if (product) {
            let reply = `ðŸŒŸ ${product.name}\nØ§Ù„Ø³Ø¹Ø± Ù…ØªØ§Ø¹Ù‡Ø§: ${product.price} Ø¯Øª ðŸ’¸\n`;
            reply += `Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…ØªÙˆÙÙ‘Ø± Ù„ÙƒØ§Ù…Ù„ ØªØ±Ø§Ø¨ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø¨Ù€Ù€ 8 Ø¯Øª ðŸ‡¹ðŸ‡³ðŸšš\n`;
            reply += `ØªÙ†Ø¬Ù… ØªØ´ÙˆÙÙ‡Ø§ ÙˆØªØ·Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ø°Ø§ ðŸ‘‡\n${product.link}\n\n`;
            reply += `Ù…Ù†ØªÙˆØ¬ Ù…Ø¶Ù…ÙˆÙ† ðŸ’¯ ÙˆØ¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© ÙƒÙŠÙ…Ø§ Ø¹ÙˆÙ‘Ø¯Ù†Ø§ÙƒÙ… ÙÙŠ ÙˆÙŠØ±Ø§Ù…Ø§ Ø³ØªÙˆØ± â¤ï¸`;
            await sendImageMessage(senderId, product.image, reply);
          } else {
            await sendMessage(senderId, `Ù…Ø§ Ù„Ù‚ÙŠØªØ´ Ø§Ù„Ù…Ù†ØªÙˆØ¬ Ù‡Ø°Ø§ ðŸ˜…ØŒ ØªØ£ÙƒÙ‘Ø¯ Ù…Ù† Ø§Ù„Ø¥Ø³Ù… ÙˆÙ„Ø§ Ø§Ø¨Ø¹Ø«Ù„ÙŠ ØªØµÙˆÙŠØ±Ø© Ø¨Ø§Ø´ Ù†Ø¹Ø§ÙˆÙ†Ùƒ â¤ï¸`);
          }
        }
      }
    }
    res.status(200).send("EVENT_RECEIVED");
  } else {
    res.sendStatus(404);
  }
});

// ðŸŒ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ø¹ ÙÙŠØ³Ø¨ÙˆÙƒ
app.get("/webhook", (req, res) => {
  const mode = req.query["hub.mode"];
  const token = req.query["hub.verify_token"];
  const challenge = req.query["hub.challenge"];

  if (mode && token === VERIFY_TOKEN) {
    res.status(200).send(challenge);
  } else {
    res.sendStatus(403);
  }
});

app.get("/", (req, res) => {
  res.send("Hello");
});

