import express from "express";
import fetch from "node-fetch";
import dotenv from "dotenv";
import OpenAI from "openai";

dotenv.config();

const app = express();
app.use(express.json({ limit: "10mb" }));

// âœ… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª OpenAI
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// âœ… Ø¥Ø¹Ø¯Ø§Ø¯ WooCommerce
const WOOCOMMERCE_URL = process.env.WOOCOMMERCE_URL;
const WOOCOMMERCE_CONSUMER_KEY = process.env.WOOCOMMERCE_CONSUMER_KEY;
const WOOCOMMERCE_CONSUMER_SECRET = process.env.WOOCOMMERCE_CONSUMER_SECRET;

// ðŸ§  Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªÙˆØ¬ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©
async function getProductFromImage(imageUrl) {
  try {
    const response = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙŠØªØ¹Ø±Ù‘Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„ØµÙˆØ±." },
        {
          role: "user",
          content: [
            { type: "text", text: "Ø­Ù„Ù‘Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ£Ø¹Ø·Ù†ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªÙˆØ¬ Ø§Ù„Ø¸Ø§Ù‡Ø± ÙÙŠÙ‡Ø§ ÙÙ‚Ø·." },
            { type: "image_url", image_url: { url: imageUrl } },
          ],
        },
      ],
    });

    const productName = response.choices[0].message.content.trim();
    console.log("ðŸ” Produit dÃ©tectÃ©:", productName);
    return productName;
  } catch (error) {
    console.error("Erreur Vision:", error);
    return null;
  }
}

// ðŸ›’ Ø¯Ø§Ù„Ø© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªÙˆØ¬ ÙÙŠ WooCommerce
async function getProductPrice(productName) {
  try {
    const apiUrl = `${WOOCOMMERCE_URL}/wp-json/wc/v3/products?search=${encodeURIComponent(
      productName
    )}&consumer_key=${WOOCOMMERCE_CONSUMER_KEY}&consumer_secret=${WOOCOMMERCE_CONSUMER_SECRET}`;

    const response = await fetch(apiUrl);
    const data = await response.json();

    if (Array.isArray(data) && data.length > 0) {
      const product = data[0];
      console.log("ðŸ’° Produit trouvÃ©:", product.name, "->", product.price);
      return { name: product.name, price: product.price };
    } else {
      console.log("âŒ Aucun produit trouvÃ©.");
      return null;
    }
  } catch (error) {
    console.error("Erreur WooCommerce:", error);
    return null;
  }
}

// ðŸ“¸ Ù†Ù‚Ø·Ø© API Ù„ØªÙ„Ù‚Ù‘ÙŠ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„
app.post("/api/analyse-image", async (req, res) => {
  const { imageUrl } = req.body;

  if (!imageUrl) {
    return res.status(400).json({ error: "Image URL manquante" });
  }

  const productName = await getProductFromImage(imageUrl);
  if (!productName) {
    return res.status(500).json({ error: "Impossible dâ€™identifier le produit" });
  }

  const productData = await getProductPrice(productName);
  if (productData) {
    return res.json({
      success: true,
      product: productData.name,
      price: `${productData.price} DT`,
      livraison: "Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù€ 8 Ø¯Øª Ù„ÙƒØ§Ù…Ù„ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© ðŸšš",
    });
  } else {
    return res.json({
      success: false,
      message: "Ù…Ø§ Ù„Ù‚ÙŠÙ†Ø§Ø´ Ø§Ù„Ù…Ù†ØªÙˆØ¬ Ù‡Ø°Ø§ ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø± ðŸ˜•",
    });
  }
});

// âœ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
const PORT = process.env.PORT || 10000;
app.listen(PORT, () => {
  console.log(`âœ… Wirama Bot is running on port ${PORT}`);
});
