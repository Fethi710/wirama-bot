import express from "express";
import bodyParser from "body-parser";
import fetch from "node-fetch";
import { OpenAI } from "openai";

const app = express();
app.use(bodyParser.json());

const PAGE_ACCESS_TOKEN = process.env.PAGE_ACCESS_TOKEN;
const VERIFY_TOKEN = process.env.VERIFY_TOKEN;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const WOOCOMMERCE_URL = process.env.WOOCOMMERCE_URL;
const WOOCOMMERCE_CONSUMER_KEY = process.env.WOOCOMMERCE_CONSUMER_KEY;
const WOOCOMMERCE_CONSUMER_SECRET = process.env.WOOCOMMERCE_CONSUMER_SECRET;

const openai = new OpenAI({ apiKey: OPENAI_API_KEY });

// ğŸ“¦ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ WooCommerce
async function getProductPrice(productName) {
  try {
    const response = await fetch(
      `${WOOCOMMERCE_URL}/wp-json/wc/v3/products?search=${encodeURIComponent(
        productName
      )}&consumer_key=${WOOCOMMERCE_CONSUMER_KEY}&consumer_secret=${WOOCOMMERCE_CONSUMER_SECRET}`
    );

    const products = await response.json();
    if (!products || products.length === 0) return null;

    const p = products[0];
    return {
      name: p.name,
      price: p.price,
      link: p.permalink,
      image: p.images?.[0]?.src || null,
    };
  } catch (err) {
    console.error("Erreur WooCommerce:", err);
    return null;
  }
}

// ğŸ§  Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©
async function getProductFromImage(imageUrl) {
  try {
    const response = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content:
            "Ø¥Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© Ø§Ù„ØªÙˆÙ†Ø³ÙŠØ©. Ø´ÙˆÙ Ø§Ù„ØµÙˆØ±Ø© ÙˆÙ‚ÙˆÙ„ÙŠ Ø´Ù†ÙˆÙ‘Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù‚ØµÙŠØ±Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø·Ù†Ø¬Ø±Ø©ØŒ Ø³Ø±Ø¨ÙŠØ³ Ù‚Ù‡ÙˆØ©...).",
        },
        {
          role: "user",
          content: `Ø´Ù†ÙˆÙ‘Ø© Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©ØŸ\n![image](${imageUrl})`,
        },
      ],
    });

    const description =
      response.choices && response.choices[0] && response.choices[0].message
        ? response.choices[0].message.content
        : null;
    return description;
  } catch (err) {
    console.error("Erreur Vision:", err);
    return null;
  }
}

// âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Messenger
async function sendMessage(senderId, message) {
  await fetch(
    `https://graph.facebook.com/v17.0/me/messages?access_token=${PAGE_ACCESS_TOKEN}`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        recipient: { id: senderId },
        message: { text: message },
      }),
    }
  );
}

// ğŸ–¼ï¸ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© + Ù†Øµ
async function sendImageMessage(senderId, imageUrl, text) {
  await fetch(
    `https://graph.facebook.com/v17.0/me/messages?access_token=${PAGE_ACCESS_TOKEN}`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        recipient: { id: senderId },
        message: {
          attachment: {
            type: "image",
            payload: { url: imageUrl, is_reusable: true },
          },
        },
      }),
    }
  );

  await sendMessage(senderId, text);
}

// ğŸ“¬ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ù…Ø³Ù†Ø¬Ø±
app.post("/webhook", async (req, res) => {
  const body = req.body;

  if (body.object === "page") {
    for (const entry of body.entry) {
      const webhookEvent = entry.messaging[0];
      const senderId = webhookEvent.sender.id;

      if (webhookEvent.message) {
        const msgText = webhookEvent.message.text?.toLowerCase() || "";

        // ğŸ‘‹ Ø§Ù„ØªØ±Ø­ÙŠØ¨
        if (["Ø³Ù„Ø§Ù…", "Ù…Ø±Ø­Ø¨Ø§", "Ø£Ù‡Ù„Ø§", "bonjour", "hi"].some((w) => msgText.includes(w))) {
          await sendMessage(senderId, "Ù…Ø±Ø­Ø¨Ø§Ù‹! ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ");
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙˆØ±Ø©
        if (webhookEvent.message.attachments) {
          const attachment = webhookEvent.message.attachments[0];
          if (attachment.type === "image") {
            const imageUrl = attachment.payload.url;
            const productDescription = await getProductFromImage(image







